\ProvidesPackage{pflichtenheft}
\RequirePackage{xcolor}
\RequirePackage{rdfref-user,rdfref-query}

% cross referencing
\newcommand\tests[1]{%
  \AddTripleEx{#1}{pfl:is-tested}{yeah}
  \AddProperty{pfl:tests}{#1}}
\newcommand\fulfills[1]{%
  \AddTripleEx{#1}{pfl:is-fulfilled}{yeah}
  \AddProperty{pfl:fulfills}{#1}}
\newcommand\testlink[1]{\hyperref[#1]%
  {\GetProperty{#1}{pfl:tstid}}}
\newcommand\functionalitylink[1]{\hyperref[#1]%
  {\GetProperty{#1}{pfl:fncid}}}
\newcommand\criteriumlink[1]{\hyperref[#1]%
  {\GetProperty{#1}{pfl:crtid}}}
\newcommand\marginid[1]{\marginpar{\centering\textbf{#1}}}

\newcommand\PrefixMussKriterium{M}
\newcommand\PrefixKannKriterium{K}
\newcommand\PrefixAbgrenzungsKriterium{A}
\newcommand\PrefixFunktional{F}
\newcommand\PrefixNichtFunktional{N}
\newcommand\PrefixTest{T}

% make sure renewcommand on temporary variable works
\newcommand\id{NO ID SPECIFIED - THIS SHOULD NOT APPEAR IN FINAL DOCUMENT}
\newcommand\curTest{NO TEST SPECIFIED - THIS SHOULD NOT APPEAR IN FINAL DOCUMENT}

\newcounter{teststep}

% document macros
\newcommand\criterium[3]{
  \par\textbf{#1}\rdflabel{#2}
  \renewcommand\id{\PrefixMussKriterium #3}
  \marginid{\id}
  \AddPropertyEx{pfl:crtname}{#1}
  \AddPropertyEx{pfl:crtid}{\id}
  \IfProperty{#2}{pfl:is-fulfilled}{%
    \\ Implementiert durch: \Bind{?f}{pfl:fulfills}{#2}{ \functionalitylink{\GetVal{?f}} }
  }{{\color{red}{NICHT IMPLEMENTIERT}}}
  \par}

\newcommand\criteriumOptional[3]{
  \par\textbf{#1}\rdflabel{#2}
  \renewcommand\id{\PrefixKannKriterium #3}
  \marginid{\id}
  \AddPropertyEx{pfl:crtname}{#1}
  \AddPropertyEx{pfl:crtid}{\id}
  \IfProperty{#2}{pfl:is-fulfilled}{%
    \\ Implementiert durch: \Bind{?f}{pfl:fulfills}{#2}{ \functionalitylink{\GetVal{?f}} }
  }{{\color{red} keine entsprechende Anforderung}}
  \par}

\newcommand\criteriumNot[3]{
  \par\textbf{#1}\rdflabel{#2}
  \renewcommand\id{\PrefixAbgrenzungsKriterium #3}
  \marginid{\id}
  \AddPropertyEx{pfl:crtname}{#1}
  \AddPropertyEx{pfl:crtid}{\id}
  \par}

\newcommand\functionality[3]{
  \par\textbf{#1}\rdflabel{#2}
  \renewcommand\id{\PrefixFunktional #3}
  \marginid{\id}
  \AddPropertyEx{pfl:fncname}{#1}
  \AddPropertyEx{pfl:fncid}{\id}
  \IfProperty{#2}{pfl:is-tested}{%
    \\ Getestet durch: \Bind{?t}{pfl:tests}{#2}{ \testlink{\GetVal{?t}} }
  }{{\color{red}{NICHT GETESTET}}\\}
  Implementiert: \Bind{#2}{pfl:fulfills}{?c}{ \criteriumlink{\GetVal{?c}} }
  \par}

\newcommand\nonFunctionality[3]{
  \par\textbf{#1}\rdflabel{#2}
  \renewcommand\id{\PrefixNichtFunktional #3}
  \marginid{\id}
  \AddPropertyEx{pfl:fncname}{#1}
  \AddPropertyEx{pfl:fncid}{\id}
  \par}

\newcommand\test[3]{
  \renewcommand\curTest{#3}
  \setcounter{teststep}{0}
  \par\textbf{#1}\rdflabel{#2}
  \renewcommand\id{\PrefixTest #3}
  \marginid{\id}
  \AddPropertyEx{pfl:tstname}{#1}
  \AddPropertyEx{pfl:tstid}{\id}
  \\ Testet: \Bind{#2}{pfl:tests}{?f}{ \functionalitylink{\GetVal{?f}} }
  \par}

\newcommand\teststep[3]{\stepcounter{teststep}
{\PrefixTest\curTest.\arabic{teststep}}
\begin{minipage}[t]{0.8\textwidth}\raggedright
\textbf{Stand:} #1\par
\textbf{Aktion:} #2\par
\textbf{Reaktion:} #3\par
\end{minipage}
\par}
